version: "3.9"

services:
  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    depends_on:
      gpt:
        condition: service_healthy
    environment:
      - BOT_TOKEN=${BOT_TOKEN}
      - API_SECRET_KEY=${API_SECRET_KEY}
      - REQUEST_TIMEOUT=600
      - GPT_SERVICE_URL=http://gpt:9001
    volumes:
      - ./bot:/app/bot
    networks:
      - app-network

  gpt:
    build:
      context: .
      dockerfile: gpt_integration/Dockerfile
    ports:
      - "9001:9001"
    environment:
      - GPT_PORT=9001
      - API_SECRET_KEY=${API_SECRET_KEY}
      - BOT_TOKEN=${BOT_TOKEN}
      # OpenAI API
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o-mini}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.7}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-4000}
      - OPENAI_TIMEOUT=${OPENAI_TIMEOUT:-60}
      - OPENAI_MAX_RETRIES=${OPENAI_MAX_RETRIES:-3}
      - OPENAI_MAX_RETRIES_CONNECTION=${OPENAI_MAX_RETRIES_CONNECTION:-8}
      - OPENAI_RETRY_DELAY_MS=${OPENAI_RETRY_DELAY_MS:-500}
      - OPENAI_RETRY_DELAY_CONNECTION_MS=${OPENAI_RETRY_DELAY_CONNECTION_MS:-2000}
      - OPENAI_RETRY_BACKOFF=${OPENAI_RETRY_BACKOFF:-2}
      # Photo Processing - API генерации изображений
      - COMET_API_KEY=${COMET_API_KEY}
      - IMAGE_GEN_API_KEY=${IMAGE_GEN_API_KEY:-}
      - IMAGE_GEN_BASE_URL=${IMAGE_GEN_BASE_URL:-}
      - IMAGE_GEN_MODEL=${IMAGE_GEN_MODEL}
      - IMAGE_GEN_TIMEOUT=${IMAGE_GEN_TIMEOUT:-60}
      - IMAGE_GEN_MAX_RETRIES=${IMAGE_GEN_MAX_RETRIES:-3}
      # Photo Processing - Хранение результатов
      - PHOTO_STORAGE_TYPE=${PHOTO_STORAGE_TYPE:-url}
    volumes:
      - ./gpt_integration:/app/gpt_integration
      - ./bot/utils:/app/utils
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  app-network:
    driver: bridge
